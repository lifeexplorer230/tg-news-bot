"""–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Gemini API"""
import google.generativeai as genai
import json
from typing import List, Dict, Optional
from utils.logger import setup_logger

logger = setup_logger(__name__)


class GeminiClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Gemini API"""

    def __init__(self, api_key: str, model_name: str = "gemini-1.5-flash"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gemini –∫–ª–∏–µ–Ω—Ç–∞

        Args:
            api_key: API –∫–ª—é—á Google Gemini
            model_name: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
        """
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel(model_name)
        logger.info(f"Gemini –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: {model_name}")

    def select_top_news(self, messages: List[Dict], top_n: int = 10) -> List[Dict]:
        """
        –û—Ç–æ–±—Ä–∞—Ç—å –¢–û–ü-N —Å–∞–º—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ AI

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ–ª—è–º–∏ {id, text, channel}
            top_n: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –æ—Ç–±–æ—Ä–∞

        Returns:
            –°–ø–∏—Å–æ–∫ –æ—Ç–æ–±—Ä–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π —Å –æ—Ü–µ–Ω–∫–∞–º–∏
        """
        if not messages:
            return []

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        messages_text = "\n\n".join([
            f"ID: {msg['id']}\n–ö–∞–Ω–∞–ª: @{msg.get('channel_username', 'unknown')}\n–¢–µ–∫—Å—Ç:\n{msg['text'][:500]}"
            for msg in messages
        ])

        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–æ–≤–æ—Å—Ç—è–º –ø—Ä–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –∫–∞–Ω–∞–ª–æ–≤ –∏ –æ—Ç–±–µ—Ä–∏ –¢–û–ü-{top_n} —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π.

–ö–†–ò–¢–ï–†–ò–ò –û–¢–ë–û–†–ê (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):

–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 9-10):
‚úÖ –ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π (GPT-5, Claude, Gemini, Perplexity, Grok)
‚úÖ –ù–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ AI-–ø—Ä–æ–¥—É–∫—Ç–∞—Ö

–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 7-8):
‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∫–µ–π—Å—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI
‚úÖ –ó–∞–±–∞–≤–Ω—ã–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è AI

–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 5-6):
‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–±—É—á–µ–Ω–∏—è –æ—Ç –∫—Ä—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ (OpenAI, Google, Anthropic)
‚úÖ –ù–∞—É—á–Ω—ã–µ –ø—Ä–æ—Ä—ã–≤—ã, SOTA —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–°–ö–õ–Æ–ß–ò–¢–¨:
‚ùå –†–µ–∫–ª–∞–º—É –ø–ª–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤, –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —É—Å–ª—É–≥
‚ùå –ú–µ–º—ã –±–µ–∑ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
‚ùå –ü–æ–ª–∏—Ç–∏–∫—É –±–µ–∑ AI –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚ùå –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã (–µ—Å–ª–∏ –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ –Ω–æ–≤–æ—Å—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞—Ö - –≤—ã–±–µ—Ä–∏ –ª—É—á—à–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
‚ùå –û–±—â–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏

–°–û–û–ë–©–ï–ù–ò–Ø:

{messages_text}

–í–µ—Ä–Ω–∏ JSON –º–∞—Å—Å–∏–≤ —Å –¢–û–ü-{top_n} –Ω–æ–≤–æ—Å—Ç—è–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
[
  {{"id": –Ω–æ–º–µ—Ä_ID_–∏–∑_—Å–ø–∏—Å–∫–∞, "score": –æ—Ü–µ–Ω–∫–∞_–æ—Ç_1_–¥–æ_10, "reason": "–∫—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–±–æ—Ä–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º"}},
  ...
]

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        try:
            response = self.model.generate_content(prompt)
            result_text = response.text.strip()

            # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            logger.debug(f"Gemini –æ—Ç–≤–µ—Ç (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): {result_text[:500]}")

            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ (–∏–Ω–æ–≥–¥–∞ Gemini –¥–æ–±–∞–≤–ª—è–µ—Ç ```json```)
            if "```json" in result_text:
                result_text = result_text.split("```json")[1].split("```")[0].strip()
            elif "```" in result_text:
                result_text = result_text.split("```")[1].split("```")[0].strip()

            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –º–∞—Å—Å–∏–≤ —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–∫–∏ –µ—Å–ª–∏ –ø—Ä—è–º–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            if not result_text.startswith("["):
                import re
                json_match = re.search(r'\[[\s\S]*\]', result_text)
                if json_match:
                    result_text = json_match.group(0)
                else:
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –º–∞—Å—Å–∏–≤ –≤ –æ—Ç–≤–µ—Ç–µ Gemini: {result_text}")
                    return []

            selected = json.loads(result_text)
            logger.info(f"Gemini –æ—Ç–æ–±—Ä–∞–ª {len(selected)} –Ω–æ–≤–æ—Å—Ç–µ–π –∏–∑ {len(messages)}")
            return selected[:top_n]

        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}")
            logger.error(f"–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞: {result_text}")
            return []
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–±–æ—Ä–µ –Ω–æ–≤–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ Gemini: {e}")
            return []

    def format_news_post(self, text: str, channel: str, message_link: str = None) -> Optional[Dict]:
        """
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

        Args:
            text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏
            channel: –ö–∞–Ω–∞–ª-–∏—Å—Ç–æ—á–Ω–∏–∫
            message_link: –°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

        Returns:
            Dict —Å –ø–æ–ª—è–º–∏: title, description, source_link
        """
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å –ø—Ä–æ AI –∏ —Å–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ.

–ò–°–•–û–î–ù–ê–Ø –ù–û–í–û–°–¢–¨:
{text}

–ó–ê–î–ê–ß–ê:
–°–æ–∑–¥–∞–π JSON —Å –ø–æ–ª—è–º–∏:
1. "title" - –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ 5-10 —Å–ª–æ–≤, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å —Ç–µ–º—ã (–ë–ï–ó —ç–º–æ–¥–∑–∏)
2. "description" - –æ–ø–∏—Å–∞–Ω–∏–µ –≤ 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏

–ü–†–ê–í–ò–õ–ê:
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ —ç–º–æ–¥–∑–∏, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
- –û–ø–∏—Å–∞–Ω–∏–µ: –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞, —Ñ–∞–∫—Ç—ã, —Ü–∏—Ñ—Ä—ã
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
- –ë–µ–∑ –≤–æ–¥—ã –∏ —Ö–∞–π–ø–∞

–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê:
{{
  "title": "ANUS - –æ–ø–µ–Ω—Å–æ—Ä—Å–Ω—ã–π –∫–ª–æ–Ω Manus AI, —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–∞–º–æ–π —Å–∏—Å—Ç–µ–º–æ–π",
  "description": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø—Ä–æ—Å–∏–ª Manus —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –≤–µ—Ä—Å–∏—é —Å –æ—Ç–∫—Ä—ã—Ç—ã–º –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º, –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ—è–≤–∏–ª—Å—è ANUS (Autonomous Networked Utility System) - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ —Å –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º. –ü—Ä–æ–µ–∫—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ GitHub –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º –Ω–∞ –±–∞–∑–µ LLM."
}}

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        try:
            response = self.model.generate_content(prompt)
            result_text = response.text.strip()

            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            if "```json" in result_text:
                result_text = result_text.split("```json")[1].split("```")[0].strip()
            elif "```" in result_text:
                result_text = result_text.split("```")[1].split("```")[0].strip()

            formatted = json.loads(result_text)

            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫
            formatted['source_link'] = message_link if message_link else f"https://t.me/{channel}"

            return formatted

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞ —á–µ—Ä–µ–∑ Gemini: {e}")
            return None

    def select_and_format_news(self, messages: List[Dict], top_n: int = 10) -> List[Dict]:
        """
        –ù–û–í–ê–Ø –°–•–ï–ú–ê: –û—Ç–æ–±—Ä–∞—Ç—å –ò –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–û–ü-N –Ω–æ–≤–æ—Å—Ç–µ–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ–ª—è–º–∏ {id, text, channel}
            top_n: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –æ—Ç–±–æ—Ä–∞

        Returns:
            –°–ø–∏—Å–æ–∫ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π —Å –ø–æ–ª—è–º–∏:
            {id, title, description, source_link, score, reason}
        """
        if not messages:
            return []

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        messages_text = "\n\n".join([
            f"ID: {msg['id']}\n–ö–∞–Ω–∞–ª: @{msg.get('channel_username', 'unknown')}\n–¢–µ–∫—Å—Ç:\n{msg['text'][:500]}"
            for msg in messages
        ])

        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–æ–≤–æ—Å—Ç—è–º –ø—Ä–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –∫–∞–Ω–∞–ª–æ–≤, –æ—Ç–±–µ—Ä–∏ –¢–û–ü-{top_n} —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ò –°–†–ê–ó–£ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π –∏—Ö.

–ö–†–ò–¢–ï–†–ò–ò –û–¢–ë–û–†–ê (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):

–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 9-10):
‚úÖ –ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π (GPT-5, Claude, Gemini, Perplexity, Grok)
‚úÖ –ù–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ AI-–ø—Ä–æ–¥—É–∫—Ç–∞—Ö

–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 7-8):
‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∫–µ–π—Å—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI
‚úÖ –ó–∞–±–∞–≤–Ω—ã–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è AI

–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 5-6):
‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –æ–±—É—á–µ–Ω–∏—è –æ—Ç –∫—Ä—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ (OpenAI, Google, Anthropic)
‚úÖ –ù–∞—É—á–Ω—ã–µ –ø—Ä–æ—Ä—ã–≤—ã, SOTA —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–°–ö–õ–Æ–ß–ò–¢–¨:
‚ùå –†–µ–∫–ª–∞–º—É –ø–ª–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤, –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —É—Å–ª—É–≥
‚ùå –ú–µ–º—ã –±–µ–∑ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
‚ùå –ü–æ–ª–∏—Ç–∏–∫—É –±–µ–∑ AI –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
‚ùå –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã (–µ—Å–ª–∏ –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ –Ω–æ–≤–æ—Å—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞—Ö - –≤—ã–±–µ—Ä–∏ –ª—É—á—à–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
‚ùå –û–±—â–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏

–°–û–û–ë–©–ï–ù–ò–Ø:

{messages_text}

–í–µ—Ä–Ω–∏ JSON –º–∞—Å—Å–∏–≤ —Å –¢–û–ü-{top_n} –Ω–æ–≤–æ—Å—Ç—è–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
[
  {{
    "id": –Ω–æ–º–µ—Ä_ID_–∏–∑_—Å–ø–∏—Å–∫–∞,
    "score": –æ—Ü–µ–Ω–∫–∞_–æ—Ç_1_–¥–æ_10,
    "reason": "–∫—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–±–æ—Ä–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
    "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ 5-10 —Å–ª–æ–≤ –ë–ï–ó —ç–º–æ–¥–∑–∏",
    "description": "–û–ø–∏—Å–∞–Ω–∏–µ –≤ 2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏"
  }},
  ...
]

–ü–†–ê–í–ò–õ–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø:
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ —ç–º–æ–¥–∑–∏, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
- –û–ø–∏—Å–∞–Ω–∏–µ: –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞, —Ñ–∞–∫—Ç—ã, —Ü–∏—Ñ—Ä—ã
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
- –ë–µ–∑ –≤–æ–¥—ã –∏ —Ö–∞–π–ø–∞

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        try:
            response = self.model.generate_content(prompt)
            result_text = response.text.strip()

            # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            logger.debug(f"Gemini –æ—Ç–≤–µ—Ç (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): {result_text[:500]}")

            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            if "```json" in result_text:
                result_text = result_text.split("```json")[1].split("```")[0].strip()
            elif "```" in result_text:
                result_text = result_text.split("```")[1].split("```")[0].strip()

            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –º–∞—Å—Å–∏–≤ —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–∫–∏
            if not result_text.startswith("["):
                import re
                json_match = re.search(r'\[[\s\S]*\]', result_text)
                if json_match:
                    result_text = json_match.group(0)
                else:
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –º–∞—Å—Å–∏–≤ –≤ –æ—Ç–≤–µ—Ç–µ Gemini: {result_text}")
                    return []

            selected = json.loads(result_text)

            # –î–æ–±–∞–≤–ª—è–µ–º source_link –∫ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏
            messages_dict = {msg['id']: msg for msg in messages}
            for item in selected:
                msg_id = item['id']
                if msg_id in messages_dict:
                    msg = messages_dict[msg_id]
                    item['source_link'] = f"https://t.me/{msg['channel_username']}/{msg.get('message_id', '')}"
                    item['source_message_id'] = msg_id
                    item['source_channel_id'] = msg['channel_id']
                    item['text'] = msg['text']  # –î–ª—è embeddings

            logger.info(f"Gemini –æ—Ç–æ–±—Ä–∞–ª –∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–ª {len(selected)} –Ω–æ–≤–æ—Å—Ç–µ–π –∏–∑ {len(messages)}")
            return selected[:top_n]

        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}")
            logger.error(f"–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞: {result_text}")
            return []
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–±–æ—Ä–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ Gemini: {e}")
            return []

    def is_spam_or_ad(self, text: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Å–ø–∞–º–æ–º –∏–ª–∏ —Ä–µ–∫–ª–∞–º–æ–π

        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

        Returns:
            True –µ—Å–ª–∏ —ç—Ç–æ —Å–ø–∞–º/—Ä–µ–∫–ª–∞–º–∞
        """
        prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–æ–π, —Å–ø–∞–º–æ–º –∏–ª–∏ –º—É—Å–æ—Ä–æ–º.

–¢–ï–ö–°–¢:
{text[:500]}

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: "–î–ê" (–µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∫–ª–∞–º–∞/—Å–ø–∞–º) –∏–ª–∏ "–ù–ï–¢" (–µ—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ AI)."""

        try:
            response = self.model.generate_content(prompt)
            answer = response.text.strip().upper()
            return "–î–ê" in answer

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–ø–∞–º: {e}")
            return False

    def select_and_format_marketplace_news(
        self,
        messages: List[Dict],
        marketplace: str,
        top_n: int = 10
    ) -> List[Dict]:
        """
        –û—Ç–±–æ—Ä –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ (Ozon, Wildberries)

        Args:
            messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
            marketplace: –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ (ozon –∏–ª–∏ wildberries)
            top_n: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –æ—Ç–±–æ—Ä–∞

        Returns:
            –°–ø–∏—Å–æ–∫ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
        """
        if not messages:
            return []

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
        marketplace_upper = marketplace.upper()

        messages_text = "\n\n".join([
            f"ID: {msg['id']}\n–ö–∞–Ω–∞–ª: @{msg.get('channel_username', 'unknown')}\n–¢–µ–∫—Å—Ç:\n{msg['text'][:500]}"
            for msg in messages
        ])

        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É {marketplace_upper}.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –∫–∞–Ω–∞–ª–æ–≤ –ø—Ä–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã, –æ—Ç–±–µ—Ä–∏ –¢–û–ü-{top_n} —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ {marketplace_upper} –ò –°–†–ê–ó–£ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π –∏—Ö.

–ö–†–ò–¢–ï–†–ò–ò –û–¢–ë–û–†–ê (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):

–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 9-10):
‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞–±–æ—Ç–µ {marketplace_upper} (–Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –∫–æ–º–∏—Å—Å–∏–∏, —Ñ—É–Ω–∫—Ü–∏–∏)
‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç {marketplace_upper}
‚úÖ –í–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ (–∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ, –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏, –≤—ã–ø–ª–∞—Ç–∞—Ö)
‚úÖ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–∑–∞–∫–æ–Ω—ã, —Ä–µ–≥—É–ª—è—Ü–∏–∏)

–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 7-8):
‚úÖ –ö–µ–π—Å—ã —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –Ω–∞ {marketplace_upper}
‚úÖ –ù–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è {marketplace_upper}
‚úÖ –¢—Ä–µ–Ω–¥—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
‚úÖ –í–∞–∂–Ω—ã–µ –ª–∞–π—Ñ—Ö–∞–∫–∏ –∏ —Å–æ–≤–µ—Ç—ã

–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 5-6):
‚úÖ –û–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ä—ã–Ω–∫–∞
‚úÖ –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–°–ö–õ–Æ–ß–ò–¢–¨:
‚ùå –†–µ–∫–ª–∞–º—É –ø–ª–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤, –º–µ–Ω—Ç–æ—Ä—Å—Ç–≤–∞, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
‚ùå –ü—Ä–æ–¥–∞–∂—É –∞–∫–∫–∞—É–Ω—Ç–æ–≤, —Ç–æ–≤–∞—Ä–æ–≤, —É—Å–ª—É–≥
‚ùå –ú–µ–º—ã –±–µ–∑ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
‚ùå –û–±—â–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏
‚ùå –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã
‚ùå –ù–æ–≤–æ—Å—Ç–∏ –ø—Ä–æ –î–†–£–ì–ò–ï –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã (–Ω–µ {marketplace_upper})

–í–ê–ñ–ù–û: –û—Ç–±–∏—Ä–∞–π –¢–û–õ–¨–ö–û –Ω–æ–≤–æ—Å—Ç–∏ –ø—Ä–æ {marketplace_upper}! –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è Wildberries –∞ –Ω—É–∂–µ–Ω Ozon - –Ω–µ –≤–∫–ª—é—á–∞–π. –ò –Ω–∞–æ–±–æ—Ä–æ—Ç.

–°–û–û–ë–©–ï–ù–ò–Ø:
{messages_text}

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –º–∞—Å—Å–∏–≤–∞:
[
  {{
    "id": <ID —Å–æ–æ–±—â–µ–Ω–∏—è>,
    "title": "<–ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ 5-7 —Å–ª–æ–≤>",
    "description": "<–û–ø–∏—Å–∞–Ω–∏–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>",
    "score": <—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10>,
    "reason": "<–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É –≤–∞–∂–Ω–æ>"
  }}
]

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        try:
            response = self.model.generate_content(prompt)
            result_text = response.text.strip()

            logger.debug(f"–û—Ç–≤–µ—Ç Gemini (–º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å {marketplace}): {result_text[:500]}")

            # –£–¥–∞–ª—è–µ–º markdown —Ä–∞–∑–º–µ—Ç–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
            if result_text.startswith("```"):
                result_text = result_text.split("```")[1]
                if result_text.startswith("json"):
                    result_text = result_text[4:]
                result_text = result_text.strip()

            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –º–∞—Å—Å–∏–≤
            if not result_text.startswith("["):
                json_match = re.search(r'\[[\s\S]*\]', result_text)
                if json_match:
                    result_text = json_match.group(0)
                else:
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ Gemini: {result_text}")
                    return []

            selected = json.loads(result_text)

            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            messages_dict = {msg['id']: msg for msg in messages}
            for item in selected:
                msg_id = item['id']
                if msg_id in messages_dict:
                    msg = messages_dict[msg_id]
                    item['source_link'] = f"https://t.me/{msg['channel_username']}/{msg.get('message_id', '')}"
                    item['source_message_id'] = msg_id
                    item['source_channel_id'] = msg['channel_id']
                    item['text'] = msg['text']
                    item['marketplace'] = marketplace

            logger.info(f"Gemini –æ—Ç–æ–±—Ä–∞–ª {len(selected)} –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è {marketplace} –∏–∑ {len(messages)}")
            return selected[:top_n]

        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini ({marketplace}): {e}")
            logger.error(f"–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞: {result_text}")
            return []
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–±–æ—Ä–µ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è {marketplace}: {e}")
            return []

    def select_three_categories(
        self,
        messages: List[Dict],
        wb_count: int = 5,
        ozon_count: int = 5,
        general_count: int = 5
    ) -> Dict[str, List[Dict]]:
        """
        –û—Ç–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ 3 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: Wildberries, Ozon, –û–±—â–∏–µ

        Args:
            messages: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            wb_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ Wildberries
            ozon_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ Ozon
            general_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—â–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π

        Returns:
            Dict —Å –∫–ª—é—á–∞–º–∏ 'wildberries', 'ozon', 'general'
        """
        if not messages:
            return {'wildberries': [], 'ozon': [], 'general': []}

        messages_text = "\n\n".join([
            f"ID: {msg['id']}\n–ö–∞–Ω–∞–ª: @{msg.get('channel_username', 'unknown')}\n–¢–µ–∫—Å—Ç:\n{msg['text'][:500]}"
            for msg in messages
        ])

        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º (Wildberries –∏ Ozon).

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram –∫–∞–Ω–∞–ª–æ–≤ –ø—Ä–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã –∏ –æ—Ç–±–µ—Ä–∏ –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ 3 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

üì¶ –ö–ê–¢–ï–ì–û–†–ò–Ø 1: WILDBERRIES ({wb_count} –Ω–æ–≤–æ—Å—Ç–µ–π)
–ù–æ–≤–æ—Å—Ç–∏ –¢–û–õ–¨–ö–û –ø—Ä–æ Wildberries (–≤–∫–ª—é—á–∞—è "WB", "–í–ë", "–≤–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑")

üì¶ –ö–ê–¢–ï–ì–û–†–ò–Ø 2: OZON ({ozon_count} –Ω–æ–≤–æ—Å—Ç–µ–π)
–ù–æ–≤–æ—Å—Ç–∏ –¢–û–õ–¨–ö–û –ø—Ä–æ Ozon (–≤–∫–ª—é—á–∞—è "–æ–∑–æ–Ω")

üì¶ –ö–ê–¢–ï–ì–û–†–ò–Ø 3: –û–ë–©–ò–ï ({general_count} –Ω–æ–≤–æ—Å—Ç–µ–π)
- –ù–æ–≤–æ—Å—Ç–∏ –∫–∞—Å–∞—é—â–∏–µ—Å—è –û–ë–û–ò–• –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
- –û–±—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ –¥–ª—è –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
- –°–æ–≤–µ—Ç—ã –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ –∫ –ª—é–±–æ–º—É –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É
- –¢—Ä–µ–Ω–¥—ã —Ä—ã–Ω–∫–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤ –≤ —Ü–µ–ª–æ–º

–ö–†–ò–¢–ï–†–ò–ò –û–¢–ë–û–†–ê (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):

–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 9-10):
‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞–±–æ—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –∫–æ–º–∏—Å—Å–∏–∏, —Ñ—É–Ω–∫—Ü–∏–∏)
‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
‚úÖ –í–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ (–∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ, –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏, –≤—ã–ø–ª–∞—Ç–∞—Ö)
‚úÖ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–∑–∞–∫–æ–Ω—ã, —Ä–µ–≥—É–ª—è—Ü–∏–∏)
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –æ—Ç –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞

–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 7-8):
‚úÖ –ö–µ–π—Å—ã —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–¥–∞–≤—Ü–æ–≤
‚úÖ –ù–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Å–µ—Ä–≤–∏—Å—ã
‚úÖ –¢—Ä–µ–Ω–¥—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
‚úÖ –í–∞–∂–Ω—ã–µ –ª–∞–π—Ñ—Ö–∞–∫–∏ –∏ —Å–æ–≤–µ—Ç—ã –æ—Ç —ç–∫—Å–ø–µ—Ä—Ç–æ–≤

–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–æ—Ü–µ–Ω–∫–∞ 5-6):
‚úÖ –û–±—â–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ä—ã–Ω–∫–∞
‚úÖ –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–°–ö–õ–Æ–ß–ò–¢–¨:
‚ùå –†–µ–∫–ª–∞–º—É –ø–ª–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤, –º–µ–Ω—Ç–æ—Ä—Å—Ç–≤–∞, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π, –≤–µ–±–∏–Ω–∞—Ä–æ–≤
‚ùå –ü—Ä–æ–¥–∞–∂—É –∞–∫–∫–∞—É–Ω—Ç–æ–≤, —Ç–æ–≤–∞—Ä–æ–≤, —É—Å–ª—É–≥
‚ùå –ú–µ–º—ã –±–µ–∑ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
‚ùå –û–±—â–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏
‚ùå –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ç–µ–º—ã

–°–û–û–ë–©–ï–ù–ò–Ø:
{messages_text}

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –æ–±—ä–µ–∫—Ç–∞ —Å —Ç—Ä–µ–º—è –º–∞—Å—Å–∏–≤–∞–º–∏:
{{
  "wildberries": [
    {{
      "id": <ID —Å–æ–æ–±—â–µ–Ω–∏—è>,
      "title": "<–ó–∞–≥–æ–ª–æ–≤–æ–∫ 5-7 —Å–ª–æ–≤>",
      "description": "<–û–ø–∏—Å–∞–Ω–∏–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>",
      "score": <—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10>,
      "reason": "<–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ>"
    }}
  ],
  "ozon": [
    {{
      "id": <ID —Å–æ–æ–±—â–µ–Ω–∏—è>,
      "title": "<–ó–∞–≥–æ–ª–æ–≤–æ–∫ 5-7 —Å–ª–æ–≤>",
      "description": "<–û–ø–∏—Å–∞–Ω–∏–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>",
      "score": <—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10>,
      "reason": "<–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ>"
    }}
  ],
  "general": [
    {{
      "id": <ID —Å–æ–æ–±—â–µ–Ω–∏—è>,
      "title": "<–ó–∞–≥–æ–ª–æ–≤–æ–∫ 5-7 —Å–ª–æ–≤>",
      "description": "<–û–ø–∏—Å–∞–Ω–∏–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>",
      "score": <—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10>,
      "reason": "<–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ>"
    }}
  ]
}}

–í–ê–ñ–ù–û:
- Wildberries: –æ—Ç–±–∏—Ä–∞–π –¢–û–õ–¨–ö–û –Ω–æ–≤–æ—Å—Ç–∏ –≥–¥–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è Wildberries/WB/–í–ë
- Ozon: –æ—Ç–±–∏—Ä–∞–π –¢–û–õ–¨–ö–û –Ω–æ–≤–æ—Å—Ç–∏ –≥–¥–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è Ozon/–û–∑–æ–Ω
- General: –Ω–æ–≤–æ—Å—Ç–∏ –ø—Ä–æ –æ–±–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ –ò–õ–ò –æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö
- –ù–µ –¥—É–±–ª–∏—Ä—É–π: –æ–¥–Ω–∞ –Ω–æ–≤–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –≤ –û–î–ù–û–ô –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –°–æ—Ä—Ç–∏—Ä—É–π –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏ (score) –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        try:
            response = self.model.generate_content(prompt)
            result_text = response.text.strip()

            logger.debug(f"–û—Ç–≤–µ—Ç Gemini (3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏): {result_text[:500]}")

            # –£–¥–∞–ª—è–µ–º markdown —Ä–∞–∑–º–µ—Ç–∫—É
            if result_text.startswith("```"):
                result_text = result_text.split("```")[1]
                if result_text.startswith("json"):
                    result_text = result_text[4:]
                result_text = result_text.strip()

            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –æ–±—ä–µ–∫—Ç
            if not result_text.startswith("{"):
                json_match = re.search(r'\{[\s\S]*\}', result_text)
                if json_match:
                    result_text = json_match.group(0)
                else:
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ Gemini: {result_text}")
                    return {'wildberries': [], 'ozon': [], 'general': []}

            categories = json.loads(result_text)

            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏
            messages_dict = {msg['id']: msg for msg in messages}

            for category_name in ['wildberries', 'ozon', 'general']:
                if category_name not in categories:
                    categories[category_name] = []

                for item in categories[category_name]:
                    msg_id = item['id']
                    if msg_id in messages_dict:
                        msg = messages_dict[msg_id]
                        item['source_link'] = f"https://t.me/{msg['channel_username']}/{msg.get('message_id', '')}"
                        item['source_message_id'] = msg_id
                        item['source_channel_id'] = msg['channel_id']
                        item['text'] = msg['text']
                        item['category'] = category_name

            wb_len = len(categories.get('wildberries', []))
            ozon_len = len(categories.get('ozon', []))
            gen_len = len(categories.get('general', []))

            logger.info(f"Gemini –æ—Ç–æ–±—Ä–∞–ª –Ω–æ–≤–æ—Å—Ç–∏: WB={wb_len}, Ozon={ozon_len}, –û–±—â–∏–µ={gen_len}")

            return categories

        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini (3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏): {e}")
            logger.error(f"–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞: {result_text}")
            return {'wildberries': [], 'ozon': [], 'general': []}
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–±–æ—Ä–µ –Ω–æ–≤–æ—Å—Ç–µ–π (3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏): {e}")
            return {'wildberries': [], 'ozon': [], 'general': []}
