# FloodWait Fix - Telegram News Bot

**–î–∞—Ç–∞:** 2025-10-14
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ **3 —Ñ–∞–π–ª–∞** —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ `client.start(phone=...)`, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç **SendCodeRequest** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ Telegram. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:

- ‚ö†Ô∏è **FloodWait –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º** –Ω–∞ –¥–µ—Å—è—Ç–∫–∏ —Ç—ã—Å—è—á —Å–µ–∫—É–Ω–¥ (–¥–æ 12+ —á–∞—Å–æ–≤!)
- ‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤
- ‚ö†Ô∏è –¶–∏–∫–ª–∏—á–Ω—ã–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ `utils/telegram_helpers.py`
- –§—É–Ω–∫—Ü–∏—è `safe_connect()` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ FloodWait —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (3 —Ñ–∞–π–ª–∞)
- ‚úÖ `services/telegram_listener.py` - listener –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é
- ‚úÖ `services/marketplace_processor.py` - processor –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é
- ‚úÖ `services/status_reporter.py` - status reporter –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Å–µ—Å—Å–∏—é

## üõ†Ô∏è –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∫–æ–¥–µ

### –ë—ã–ª–æ (‚ùå –ü–õ–û–•–û):
```python
await client.start(phone=config.telegram_phone)  # –í—ã–∑—ã–≤–∞–µ—Ç SendCodeRequest!
```

### –°—Ç–∞–ª–æ (‚úÖ –•–û–†–û–®–û):
```python
from utils.telegram_helpers import safe_connect

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ë–ï–ó –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
session_name = config.get('telegram.session_name')
await safe_connect(client, session_name)
```

## üìã –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
utils/telegram_helpers.py              - –°–û–ó–î–ê–ù (–Ω–æ–≤–∞—è —É—Ç–∏–ª–∏—Ç–∞)
services/telegram_listener.py          - –ò–°–ü–†–ê–í–õ–ï–ù
services/marketplace_processor.py      - –ò–°–ü–†–ê–í–õ–ï–ù
services/status_reporter.py            - –ò–°–ü–†–ê–í–õ–ï–ù
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ **0 —Ñ–∞–π–ª–æ–≤** —Å `client.start(phone=...)` (–±—ã–ª–æ 3)
- ‚úÖ **–ù–µ—Ç SendCodeRequest** –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- ‚úÖ **–ù–µ—Ç FloodWait** –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω—É –æ—Å–Ω–æ–≤–Ω—É—é —Å–µ—Å—Å–∏—é
- ‚úÖ –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

## üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Docker)
docker ps | grep tg-news-bot

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
docker logs -f tg-news-bot

# –ó–∞–ø—É—Å—Ç–∏—Ç—å listener
python main.py listener

# –ó–∞–ø—É—Å—Ç–∏—Ç—å processor
python main.py processor
```

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `safe_connect()`** –≤–º–µ—Å—Ç–æ `client.start(phone=...)`
2. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏** (_status, _processor) - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–Ω—É –æ—Å–Ω–æ–≤–Ω—É—é
3. **–ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ FloodWait** - –ø–æ–¥–æ–∂–¥–∏—Ç–µ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π—Ç–µ
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç FloodWait –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã

–ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã –≤:
- ‚úÖ `marketplace-news-bot` (3 —Ñ–∞–π–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- ‚úÖ `ai-news-bot` (19 —Ñ–∞–π–ª–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- ‚úÖ `tg-news-bot` (3 —Ñ–∞–π–ª–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### safe_connect() —Ñ—É–Ω–∫—Ü–∏—è

```python
async def safe_connect(client: TelegramClient, session_name: str, max_wait: int = 3600) -> bool:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π FloodWait.

    Args:
        client: Telegram client
        session_name: –ò–º—è —Å–µ—Å—Å–∏–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        max_wait: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —á–∞—Å)

    Returns:
        True –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ

    Raises:
        RuntimeError: –ï—Å–ª–∏ FloodWait –ø—Ä–µ–≤—ã—à–∞–µ—Ç max_wait –∏–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞
    """
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **telegram_listener.py:91**
   - –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç: `from utils.telegram_helpers import safe_connect`
   - –ó–∞–º–µ–Ω—ë–Ω –≤—ã–∑–æ–≤: `await client.start(phone=...)` ‚Üí `await safe_connect(client, session_name)`

2. **marketplace_processor.py:848**
   - –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç: `from utils.telegram_helpers import safe_connect`
   - –£–±—Ä–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è `_processor`
   - –ó–∞–º–µ–Ω—ë–Ω –≤—ã–∑–æ–≤: `await client.start(phone=...)` ‚Üí `await safe_connect(client, session_name)`

3. **status_reporter.py:93**
   - –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç: `from utils.telegram_helpers import safe_connect`
   - –£–±—Ä–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ—Å—Å–∏—è `_status`
   - –ó–∞–º–µ–Ω—ë–Ω –≤—ã–∑–æ–≤: `await client.start(phone=...)` ‚Üí `await safe_connect(client, session_name)`

## ‚ö° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ù–µ—Ç FloodWait –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è
2. **–û–¥–Ω–∞ —Å–µ—Å—Å–∏—è** - –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –µ—Å–ª–∏ FloodWait –≤—Å—ë –∂–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∂–¥—ë—Ç
4. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–î–∞—Ç–∞:** 2025-10-14
