# üõ°Ô∏è Backup Runbook ‚Äî Marketplace News Bot

## üéØ –¶–µ–ª—å

–û–±–µ—Å–ø–µ—á–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö `marketplace_news.db` –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è —Å–µ—Ä–≤–∏—Å–∞.

## üì¶ –ß—Ç–æ –≤—Ö–æ–¥–∏—Ç

- –°–∫—Ä–∏–ø—Ç—ã:  
  - `scripts/backup_db.sh` ‚Äî —Å–æ–∑–¥–∞—ë—Ç snapshot –±–∞–∑—ã  
  - `scripts/restore_db.sh` ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±–∞–∑—É –∏–∑ snapshot
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: backups —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `./backups/` (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ `BACKUP_DIR`, `DB_PATH`)

## ‚úÖ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è

- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `marketplace-listener` –∑–∞–ø—É—â–µ–Ω (–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞—Ç–∞–ª–æ–≥—É –ø—Ä–æ–µ–∫—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ)
- SQLite —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `PRAGMA integrity_check`)
- –•—Ä–∞–Ω–∏–ª–∏—â–µ c –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º —Å–≤–æ–±–æ–¥–Ω—ã–º –º–µ—Å—Ç–æ–º –ø–æ–¥ –±—ç–∫–∞–ø—ã

## üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
./scripts/backup_db.sh

# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ Docker
docker exec marketplace-listener /app/scripts/backup_db.sh
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: —Ñ–∞–π–ª `backups/marketplace_news_<YYYYmmdd_HHMMSS>.db`.

–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É—Ç–∏:

```bash
DB_PATH=/custom/path.db BACKUP_DIR=/mnt/backups ./scripts/backup_db.sh
```

## ‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏ listener, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª—É—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
docker-compose stop marketplace-listener

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
./scripts/restore_db.sh backups/marketplace_news_20250101_090000.db

# –ó–∞–ø—É—Å—Ç–∏ listener —Å–Ω–æ–≤–∞
docker-compose up -d marketplace-listener
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç safety-copy —Ç–µ–∫—É—â–µ–π –ë–î (`backups/marketplace_news_pre_restore_<timestamp>.db`).

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ SQLite
sqlite3 data/marketplace_news.db "PRAGMA integrity_check;"

# –ë—ã—Å—Ç—Ä—ã–π smoke-test
pytest tests/test_database.py -k published --maxfail=1
```

## üìÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫

- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ: `./scripts/backup_db.sh`
- –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ: –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–≤–µ–∂–∏–π snapshot –≤–æ –≤–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- –ü–æ—Å–ª–µ —Ä–µ–ª–∏–∑–∞: –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±—ç–∫–∞–ø –≤—Ä—É—á–Ω—É—é

–ü—Ä–∏–º–µ—Ä cron (–Ω–∞ —Ö–æ—Å—Ç–µ):

```cron
0 2 * * * cd /root/marketplace-news-bot && ./scripts/backup_db.sh >> logs/backup.log 2>&1
```

## üÜò –ê–≤–∞—Ä–∏–π–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç

1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç –≤ –ª–æ–≥–∞—Ö/—Ç—Ä–µ–∫–µ—Ä–µ
2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `marketplace-listener`
3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –∫–æ–ø–∏—é
4. –ü—Ä–æ–≥–Ω–∞—Ç—å `sqlite3 ... PRAGMA integrity_check`
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ healthcheck ‚Üí `healthy`
6. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É/–∂—É—Ä–Ω–∞–ª –º–∏–≥—Ä–∞—Ü–∏–∏
